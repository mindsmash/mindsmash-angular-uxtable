/*! 
 * mindsmash-angular-uxtable v0.2.0
 * https://github.com/mindsmash/mindsmash-angular-uxtable
 * Copyright (c) 2015 mindsmash GmbH
 * License: MIT
 */
!function(a){"use strict";function b(b,d,e){this.get=function(f,g){a.isUndefined(g)&&(g={});var h=a.merge({},e,g);return new c(b,d,f,h)}}function c(b,c,d,e){for(var f=this,g="uxTable."+d,h=function(){sessionStorage[g]=JSON.stringify({page:i.page,pageSize:i.pageSize})},i=a.extend({source:a.noop,columns:[],selection:[],active:null,filters:{}},e),j=0;j<i.columns.length;j++)i.columns[j]=a.extend({show:!0,sort:!0,filter:!0,facets:!1},i.columns[j]);var k=[];f.load=function(){var d=i.requestConverter(i,f);i.source(d).then(function(d){c(function(){var c=i.responseConverter(d,f),e=c.meta.facets;delete c.meta.facets,a.extend(i,c.meta),f.setFacets(e),k=c.data,b.$emit("uxTable.dataChanged",k)})})},f.getConfig=function(){return i},f.getData=function(){return k},f.firstPage=function(){f.setPagination(0,null)},f.prevPage=function(){f.setPagination(Math.max(0,i.page-1),null)},f.nextPage=function(){f.setPagination(Math.min(i.page+1,i.pageCount-1),null)},f.lastPage=function(){f.setPagination(i.pageCount-1,null)},f.setPage=function(a){f.setPagination(a,null)},f.setPageSize=function(a){f.setPagination(null,a)},f.setPagination=function(a,c){var d=!1;null!==a&&a>=0&&a!==i.page&&(i.page=a,d=!0),null!==c&&c>0&&c!==i.pageSize&&(i.pageSize=c,d=!0),d&&(b.$emit("uxTable.configChanged",i),h(),f.load())},f.toggleVisibility=function(a){f.setVisibility(a,null)},f.setVisibility=function(b,c){a.isObject(b)&&(b=b.key);for(var d=0;d<i.columns.length;d++){var e=i.columns[d];if(e.key===b)return void(e.show=null!==c?c:!e.show)}},f.prevActive=function(){f.toggleActive(i.active-1)},f.nextActive=function(){f.toggleActive(i.active+1)},f.clearActive=function(){f.toggleActive(null)},f.toggleActive=function(a){null===a||a===i.active?i.active=null:0>a&&i.page>0?(f.prevPage(),i.active=i.pageSize-1):a>=i.pageSize&&i.page<i.pageCount-1?(f.nextPage(),i.active=0):a>=0&&a<k.length&&(i.active=a)},f.toggleSelection=function(a){f.setSelection(a,null)},f.setSelection=function(b,c){a.isObject(b)&&(b=b[i.view.selectionKey]);var d=i.selection.indexOf(b);0>d&&c!==!1?i.selection.push(b):d>=0&&c!==!0&&i.selection.splice(d,1)},f.setPageSelection=function(a){for(var b=0;b<k.length;b++){var c=k[b][i.view.selectionKey];f.setSelection(c,a)}},f.clearSelection=function(){i.selection=[],b.$emit("uxTable.configChanged",i)},f.setFilter=function(a,b){b?i.filters[a]=b:delete i.filters[a],f.load()};var l=function(b,c){for(var d=i.facets.options[b],e=0;e<c.length;e++){var f=c[e];if(f.active=!1,a.isDefined(d))for(var g=0;g<d.terms.length;g++)if(d.terms[g].term===f.term){f.active=d.terms[g].active===!0;break}}return c};f.setFacets=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c];b[d.name]={type:d.type,terms:l(d.name,d.terms)}}i.facets.options=b},f.toggleFacet=function(b,c){var d=i.facets.options[b];if(a.isDefined(d))for(var e=0;e<d.terms.length;e++){var g=d.terms[e];if(g.term===c)return g.active=!g.active,void f.load()}},f.getSorting=function(){return i.orderBy},f.setSorting=function(a,c){for(var d=0;d<i.columns.length;d++){var e=i.columns[d];if(e.key===a)return void(e.sort&&(i.orderBy&&i.orderBy.key===a?i.orderBy.asc===!0?i.orderBy.asc=!1:i.orderBy.asc===!1&&delete i.orderBy:i.orderBy={key:a,asc:c!==!1},b.$emit("uxTable.configChanged",i),f.load()))}},this.load()}a.module("mindsmash.uxTable",["mindsmash.hotkeys"]).provider("UxTableFactory",function(){var c={page:0,pageSize:10,orderBy:null,view:{ngClass:"ux-table-view table",keyboard:!0,selection:!0,selectionKey:"id",rowClick:function(a,b,c,d){c.toggleActive(b)}},pagination:{ngClass:"ux-table-pagination",maxSize:5,rotate:!0,directionLinks:!0,previousText:"‹",nextText:"›",boundaryLinks:!0,firstText:"«",lastText:"»"},paginationSize:{ngClass:"ux-table-pagination-size",template:'<span>{{ conf.pageSize }}&nbsp;<span class="caret"></span></span>',closeOnBlur:!0,closeOnSelect:!1,closeOnDeselect:!1,options:[10,25,50,100]},toggle:{ngClass:"ux-table-toggle",template:'<span><span class="glyphicon glyphicon-th" aria-hidden="true"></span>&nbsp;<span class="caret"></span></span>',closeOnBlur:!0,closeOnSelect:!1,closeOnDeselect:!1},counter:{ngClass:"ux-table-counter",template:"<span>{{ conf.page * conf.pageSize + 1 }} &ndash; {{ conf.page * conf.pageSize + conf.count }} of {{ conf.countTotal }}</span>"},selectionCounter:{ngClass:"ux-table-selection-counter",template:'<span>{{ conf.selection.length }} selected<span ng-show="conf.selection.length"> (<a href="#" ng-click="clear()">clear</a>)</span></span>'},facets:{ngClass:"ux-table-facets",maxFacetCount:10,minFacetSize:2,options:{}},requestConverter:function(b,c){for(var d=b.orderBy,e={_page:b.page,_pageSize:b.pageSize,_orderBy:d&&d.key?d.key+(d.asc?",asc":",desc"):null},f={},g=0;g<b.columns.length;g++){var h=b.columns[g];h.facets&&(f["$"+b.columns[g].key]=[""])}for(var i in b.facets.options)if(b.facets.options.hasOwnProperty(i))for(var j=b.facets.options[i],k=0;k<j.terms.length;k++){var l=j.terms[k];l.active&&f["$"+i].push(l.term)}return a.extend(e,f,b.filters)},responseConverter:function(b,c){var d={meta:{page:b.page.number,pageSize:b.page.size,pageCount:b.page.totalPages,count:b.page.numberOfElements,countTotal:b.page.totalElements,facets:b.page.facets||[]},data:b};return a.isArray(b.sort)&&b.sort.length>0&&(d.meta.orderBy={key:b.sort[0].property,asc:b.sort[0].ascending}),d}};this.setConfig=function(a){return c=a,this},this.$get=["$rootScope","$timeout",function(a,d){return new b(a,d,c)}]}).directive("uxTableView",["$rootScope","hotkeys","ElementClickListener",function(a,b,c){return{replace:!0,restrict:"AE",templateUrl:"_uxTableView.html",scope:{api:"&"},controller:["$scope",function(a){this.api=a.api()}],link:function(d,e,f,g){var h=g.api;d.conf={},d.sortBy=h.setSorting,d.rowClick=function(a,b,c){d.conf.view.rowClick(a,b,h,c)};var i=function(a,b){d.conf=b},j=function(a,b){d.data=b};b.bindTo(d).add({combo:"shift+left",callback:h.firstPage}).add({combo:"left",callback:h.prevPage}).add({combo:"right",callback:h.nextPage}).add({combo:"shift+right",callback:h.lastPage}).add({combo:"space",callback:function(a){null!==d.conf.active&&(a.preventDefault(),h.toggleSelection(d.data[d.conf.active][d.conf.view.selectionKey]))}}).add({combo:"return",callback:function(a){null!==d.conf.active&&console.log("exe")}}).add({combo:"up",callback:function(a){null!==d.conf.active&&(a.preventDefault(),h.prevActive())}}).add({combo:"down",callback:function(a){null!==d.conf.active&&(a.preventDefault(),h.nextActive())}}).add({combo:"esc",callback:function(a){null!==d.conf.active&&(a.preventDefault(),h.clearActive())}}),a.$on("uxTable.configChanged",i),a.$on("uxTable.dataChanged",j),c.register("uxTable.view",e,h.clearActive,!0),i(null,h.getConfig()),j(null,h.getData())}}}]).directive("uxTablePagination",["$rootScope",function(a){return{replace:!0,restrict:"AE",templateUrl:"_uxTablePagination.html",scope:{api:"&"},link:function(b,c,d){var e=b.api();b.conf={},b.confLocal={ngModel:0,ngChange:function(){e.setPage(b.confLocal.ngModel-1)}};var f=function(a,c){b.conf=c,b.confLocal.ngModel=c.page+1};a.$on("uxTable.configChanged",f),f(null,e.getConfig())}}}]).directive("uxTablePaginationSize",["$rootScope","$compile","$filter",function(b,c,d){return{replace:!0,restrict:"AE",templateUrl:"_uxTablePaginationSize.html",scope:{api:"&"},link:{pre:function(e,f,g){var h=e.api();e.conf={},e.confLocal={ngModel:null,options:[],extraSettings:{dynamicTitle:!1,displayProp:"label",idProp:"id",externalIdProp:"id",enableSearch:!1,selectionLimit:1,showCheckAll:!1,showUncheckAll:!1,groupByTextProvider:a.noop,scrollable:!0,scrollableHeight:"auto",smartButtonMaxItems:1,smartButtonTextConverter:a.noop},events:{onItemSelect:function(a){h.setPagination(0,a.id)}}};var i=function(b,g){for(var h=[],i=0;i<g.paginationSize.options.length;i++){var j=g.paginationSize.options[i];h.push({id:j,label:""+j})}-1===g.paginationSize.options.indexOf(g.pageSize)&&h.push({id:g.pageSize,label:""+g.pageSize}),e.conf=g,e.confLocal.ngModel={id:g.pageSize,label:""+g.pageSize},e.confLocal.options=d("orderBy")(h,"id"),e.confLocal.extraSettings.closeOnBlur=g.paginationSize.closeOnBlur,e.confLocal.extraSettings.closeOnSelect=g.paginationSize.closeOnSelect,e.confLocal.extraSettings.closeOnDeselect=g.paginationSize.closeOnDeselect;var k=g.paginationSize.template;0!==k.indexOf("<")&&(k="<span>"+k+"</span>"),a.isString(k)&&e.confLocal.template!==k&&(f.find("button.dropdown-toggle").html(c(k)(e)),e.confLocal.template=k)};b.$on("uxTable.configChanged",i),i(null,h.getConfig())}}}}]).directive("uxTableToggle",["$rootScope","$compile",function(b,c){return{replace:!0,restrict:"AE",templateUrl:"_uxTableToggle.html",scope:{api:"&"},link:{pre:function(d,e,f){var g=d.api();d.conf={},d.confLocal={ngModel:[],options:[],extraSettings:{dynamicTitle:!1,displayProp:"name",idProp:"key",externalIdProp:"key",enableSearch:!1,selectionLimit:0,showCheckAll:!1,showUncheckAll:!1,groupByTextProvider:a.noop,scrollable:!0,scrollableHeight:"auto",smartButtonMaxItems:0,smartButtonTextConverter:a.noop},events:{onItemSelect:function(a){g.setVisibility(a.key,!0)},onItemDeselect:function(a){0===d.confLocal.ngModel.length?d.confLocal.ngModel.push(a):g.setVisibility(a.key,!1)}}};var h=function(b,f){for(var g=[],h=[],i=0;i<f.columns.length;i++){var j=f.columns[i];g.push({key:j.key,name:j.name}),j.show&&h.push({key:j.key})}d.conf=f,d.confLocal.ngModel=h,d.confLocal.options=g,d.confLocal.extraSettings.closeOnBlur=f.toggle.closeOnBlur,d.confLocal.extraSettings.closeOnSelect=f.toggle.closeOnSelect,d.confLocal.extraSettings.closeOnDeselect=f.toggle.closeOnDeselect;var k=f.toggle.template;0!==k.indexOf("<")&&(k="<span>"+k+"</span>"),a.isString(k)&&d.confLocal.template!==k&&(e.find("button.dropdown-toggle").html(c(k)(d)),d.confLocal.template=k)};b.$on("uxTable.configChanged",h),h(null,g.getConfig())}}}}]).directive("uxTableCounter",["$rootScope","$compile",function(b,c){return{replace:!0,restrict:"AE",templateUrl:"_uxTableCounter.html",scope:{api:"&"},link:function(d,e,f){var g=d.api();d.conf={},d.confLocal={};var h=function(b,f){d.conf=f;var g=f.counter.template;0!==g.indexOf("<")&&(g="<span>"+g+"</span>"),a.isString(g)&&d.confLocal.template!==g&&(e.html(c(g)(d)),d.confLocal.template=g)};b.$on("uxTable.configChanged",h),h(null,g.getConfig())}}}]).directive("uxTableSelectionCounter",["$rootScope","$compile",function(b,c){return{replace:!0,restrict:"AE",templateUrl:"_uxTableSelectionCounter.html",scope:{api:"&"},link:function(d,e,f){var g=d.api();d.conf={},d.confLocal={};var h=function(b,f){d.conf=f;var g=f.selectionCounter.template;0!==g.indexOf("<")&&(g="<span>"+g+"</span>"),a.isString(g)&&d.confLocal.template!==g&&(e.html(c(g)(d)),d.confLocal.template=g)};d.clear=function(){g.clearSelection()},b.$on("uxTable.configChanged",h),h(null,g.getConfig())}}}]).directive("uxTableFacets",["$rootScope",function(a){return{replace:!0,restrict:"AE",templateUrl:"_uxTableFacets.html",scope:{api:"&"},link:function(b,c,d){var e=b.api();b.conf={};var f=function(a,c){b.conf=c};b.setFilter=function(a,b){e.setFilter(a,b)},b.toggleFacet=function(a,b){e.toggleFacet(a,b)},a.$on("uxTable.configChanged",f),f(null,e.getConfig())}}}]).directive("uxTableCell",["$compile",function(b){return{scope:!1,require:"^uxTableView",link:function(c,d,e){var f=c.column.template;a.isString(f)&&d.html(b(f)(c))}}}]).directive("uxTableSelection",["$timeout",function(a){return{replace:!0,require:"^uxTableView",scope:{api:"&",data:"=",selection:"=",selectionKey:"="},link:function(b,c,d,e){var f=e.api,g=function(a,d){if(a!==d){for(var e=0,f=0;f<b.data.length;f++)-1!==b.selection.indexOf(b.data[f][b.selectionKey])&&(e+=1);switch(e){case 0:c.prop("checked",!1).prop("indeterminate",!1);break;case b.data.length:c.prop("checked",!0).prop("indeterminate",!1);break;default:c.prop("checked",!1).prop("indeterminate",!0)}}};b.$watch("data",g,!0),b.$watch("selection",g,!0),c.bind("change",function(){a(function(){c.prop("checked")?f.setPageSelection(!0):f.setPageSelection(!1)})})}}}]).factory("ElementClickListener",["$window","$timeout",function(b,c){var d={},e=a.element(b),f=function(a,b){for(;0!==b.length;){if(b[0]===a[0])return!0;b=b.parent()}return!1};return e.on("click",function(b){for(var e in d)if(d.hasOwnProperty(e)){var g=d[e],h=g.element,i=a.element(b.target);f(h,i)?g.inverse||c(g.callback):g.inverse&&c(g.callback)}}),{register:function(b,c,e,f){d[b]={element:a.element(c),callback:e,inverse:f}},deregister:function(a){delete d[a]}}}])}(angular),angular.module("mindsmash.uxTable").run(["$templateCache",function(a){"use strict";a.put("_uxTableCounter.html",'<div ng-class="conf.counter.ngClass" ng-show="conf.countTotal"></div>'),a.put("_uxTableFacets.html",'<div ng-class="conf.facets.ngClass"><ul ng-repeat="column in conf.columns" class="list-group" ng-if="column.filter || column.facets" ng-show="column.show"><li class="list-group-item list-group-input" ng-class="{ active: !!columnFilter }" ng-if="column.filter"><span class="badge pointer pull-right" ng-click="columnFilter = \'\'; setFilter(column.key, \'\')">&times;</span> <input type="text" class="form-control input-sm" placeholder="{{ column.name }}" ng-model="columnFilter" ng-model-options="{ updateOn: \'default blur\', debounce: {\'default\': 500, \'blur\': 0} }" ng-change="setFilter(column.key, columnFilter)"></li><li ng-repeat="term in conf.facets.options[column.key].terms.slice(0, conf.facets.maxFacetCount)" ng-if="column.facets && term.count >= conf.facets.minFacetSize" class="list-group-item pointer" ng-class="{ active: term.active }" ng-click="toggleFacet(column.key, term.term)"><span class="badge pull-right">{{ term.count }}</span>{{ term.term }}</li></ul></div>'),a.put("_uxTablePagination.html",'<div ng-class="conf.pagination.ngClass" ng-show="conf.pageCount > 1"><pagination ng-change="confLocal.ngChange()" ng-model="confLocal.ngModel" total-items="conf.countTotal" items-per-page="conf.pageSize" max-size="conf.pagination.maxSize" rotate="conf.pagination.rotate" direction-links="conf.pagination.directionLinks" previous-text="{{ conf.pagination.previousText }}" next-text="{{ conf.pagination.nextText }}" boundary-links="conf.pagination.boundaryLinks" first-text="{{ conf.pagination.firstText }}" last-text="{{ conf.pagination.lastText }}"></pagination></div>'),a.put("_uxTablePaginationSize.html",'<div ng-class="conf.paginationSize.ngClass"><ng-dropdown-multiselect selected-model="confLocal.ngModel" options="confLocal.options" extra-settings="confLocal.extraSettings" events="confLocal.events"></ng-dropdown-multiselect></div>'),a.put("_uxTableSelectionCounter.html",'<div ng-class="conf.selectionCounter.ngClass" ng-show="conf.countTotal"></div>'),a.put("_uxTableToggle.html",'<div ng-class="conf.toggle.ngClass"><ng-dropdown-multiselect selected-model="confLocal.ngModel" options="confLocal.options" extra-settings="confLocal.extraSettings" events="confLocal.events" checkboxes="true"></ng-dropdown-multiselect></div>'),a.put("_uxTableView.html",'<table ng-class="conf.view.ngClass"><thead><tr><th ng-if="conf.view.selection" class="ux-table-selection"><input type="checkbox" ux-table-selection api="" data="data" selection="conf.selection" selection-key="conf.view.selectionKey"></th><th ng-repeat="column in conf.columns | filter : { show: true }" ng-click="sortBy(column.key)" ng-class="{ \'sort\': column.sort !== false, \'sort-asc\': conf.orderBy.key === column.key && conf.orderBy.asc === true, \'sort-desc\': conf.orderBy.key=== column.key && conf.orderBy.asc === false }">{{ column.name }}</th></tr></thead><tbody><tr ng-if="!data.length"><td colspan="{{ 1 + (conf.columns | filter : { show: true }).length }}" class="ux-table-empty">- - -</td></tr><tr><tr ng-repeat="row in data" ng-click="rowClick(row, $index, $event)" ng-class="{ active: conf.active === $index }"><td ng-if="conf.view.selection" class="ux-table-selection"><input type="checkbox" checklist-model="conf.selection" checklist-value="row[conf.view.selectionKey]" class="ux-table-selection-input"></td><td ng-repeat="column in conf.columns | filter : { show: true }" ux-table-cell>{{ row[column.key] }}</td></tr></tbody></table>')}]);