/*! 
 * mindsmash-angular-uxtable v0.1.1
 * https://github.com/mindsmash/mindsmash-angular-uxtable
 * Copyright (c) 2015 mindsmash GmbH
 * License: MIT
 */
!function(a){"use strict";a.module("mindsmash.uxTable",["checklist-model","angularjs-dropdown-multiselect","ui.bootstrap.pagination"]).directive("uxTableScope",function(){return{priority:100,restrict:"A",controller:["$scope",function(a){this.$isInit=!1,this.$tableCtrl=void 0,this.$tableElem=void 0,this.init=function(a,b){a&&b&&(this.$isInit=!0,this.$tableCtrl=a,this.$tableElem=b)},this.broadcast=function(b,c){a.$broadcast(b,c)}}]}}).constant("uxTableConf",{tableClass:"table",rowClass:a.noop,rowClick:a.noop,selectionKey:"id",requestConverter:function(b){var c=b.orderBy;return _.pick({_page:b.page,_pageSize:b.pageSize,_orderBy:c&&c.key?c.key+(c.asc?",asc":",desc"):null},function(b){return a.isDefined(b)&&null!==b})},responseConverter:function(b){var c={state:{count:b.page.numberOfElements,countTotal:b.page.totalElements,page:b.page.number,pageSize:b.page.size},content:b};return a.isArray(b.sort)&&b.sort.length>0&&(c.state.orderBy={key:b.sort[0].property,asc:b.sort[0].ascending}),c}}).directive("uxTable",["$http","$q","$timeout","uxTableConf",function(b,c,d,e){return{scope:!0,priority:10,restrict:"A",require:["uxTable","?^^uxTableScope"],templateUrl:"_uxTable.html",controller:["$scope","$element",function(e,f){e.state={page:0,pageSize:10,orderBy:{key:"id",asc:!0}},this.getConfig=function(){return e.cfg};var g=function(a,b){var c=e.$ctrl&&e.$ctrl.$isInit,d=c?e.$ctrl.broadcast:e.$broadcast;d(a,b)},h=null;e.content=[],this.setSource=function(b){if(!(a.isFunction(b)||a.isObject(b)||a.isArray(b)))throw"Invalid source type: "+typeof b;h=b,g("uxTable.sourceChanged",h)},this.reload=function(){var f=null;if(a.isFunction(h)){var i=e.cfg.requestConverter(e.state);f=h(i)}else if(a.isArray(h)){var j=e.state.page*e.state.pageSize,k=h.slice(j,j+e.state.pageSize),l=c.defer();l.resolve({data:k,page:{numberOfElements:k.length,totalElements:h.length,number:e.state.page,size:e.state.pageSize}}),f=l.promise}else if(a.isObject(h)){var m=e.cfg.requestConverter(e.state);f=b("GET"===h.method?a.merge({params:m},h):a.merge({data:m},h))}if(null===f)throw"Unknown source type: "+f;f.then(function(b){d(function(){var c=e.cfg.responseConverter(b);a.extend(e.state,c.state),g("uxTable.paginationChanged",{page:e.state.page,pageSize:e.state.pageSize,count:e.state.count,countTotal:e.state.countTotal}),e.content=c.content,g("uxTable.contentChanged",e.content)})})},e.columns=[];var i=function(b){return a.extend({show:!0,sort:!0},b)};this.addColumn=function(b,c){for(var d=i(b),f=0;f<e.columns.length;f++)if(e.columns[f].key===d.key)throw"Column key already defined: "+d.key;c=a.isDefined(c)?c:e.columns.length,e.columns.splice(c,0,d),g("uxTable.columnsChanged",e.columns)},this.removeColumn=function(a){for(var b=0;b<e.columns.length;b++)if(e.columns[b].key===a)return e.columns.splice(b,1),void g("uxTable.columnsChanged",e.columns);throw"Unknown column key: "+a},this.setColumns=function(a){for(var b=[],c=[],d=0;d<a.length;d++){var f=i(a[d]);if(-1!==b.indexOf(f.key))throw"Column key already defined: "+f.key;b.push(f.key),c.push(f)}e.columns=c,g("uxTable.columnsChanged",e.columns)},this.getVisibility=function(a){for(var b=0;b<e.columns.length;b++){var c=e.columns[b];if(c.key===a)return c.show}throw"Unknown column key: "+a},this.setVisibility=function(a,b){for(var c=0;c<e.columns.length;c++){var d=e.columns[c];if(d.key===a)return void(d.show!==b&&(d.show=b,g("uxTable.visibilityChanged",e.columns)))}throw"Unknown column key: "+a},this.toggleVisibility=function(a){this.getVisibility(a)?this.setVisibility(a,!1):this.setVisibility(a,!0)},this.getSorting=function(){return e.state.orderBy},this.setSorting=function(a,b){for(var c=0;c<e.columns.length;c++){var d=e.columns[c];if(d.key===a)return void(d.sort&&(e.state.orderBy&&e.state.orderBy.key===a?e.state.orderBy.asc===!0?e.state.orderBy.asc=!1:e.state.orderBy.asc===!1&&delete e.state.orderBy:e.state.orderBy={key:a,asc:b!==!1},g("uxTable.sortingChanged",e.state.orderBy),this.reload()))}throw"Unknown column key: "+a},this.getPage=function(){return e.state.page},this.setPage=function(a){this.setPagination(a,null)},this.getPageSize=function(){return e.state.pageSize},this.setPageSize=function(a){this.setPagination(null,a)},this.getPagination=function(){return{page:e.state.page,pageSize:e.state.pageSize}},this.setPagination=function(b,c){var d=!1;a.isNumber(b)&&b>=0&&(e.state.page=b,d=!0),a.isNumber(c)&&c>0&&(e.state.pageSize=c,d=!0),d&&this.reload()},e.state.selection=[],e.$watch("state.selection",function(a,b){a!==b&&g("uxTable.selectionChanged",a)},!0),this.select=function(b){if(a.isUndefined(b))e.state.selection=e.content.reduce(function(a,b){var c=b[e.cfg.selectionKey];return-1===e.state.selection.indexOf(c)&&a.push(c),a},e.state.selection);else if(a.isArray(b))e.state.selection=b.reduce(function(b,c){var d=a.isObject(c)?c[e.cfg.selectionKey]:c;return-1===e.state.selection.indexOf(d)&&b.push(d),b},e.state.selection);else{var c=a.isObject(b)?b[e.cfg.selectionKey]:b,d=e.state.selection.indexOf(c);-1===d&&e.state.selection.push(c)}},this.deselect=function(b){if(a.isUndefined(b))e.state.selection=e.content.reduce(function(a,b){var c=b[e.cfg.selectionKey],d=e.state.selection.indexOf(c);return-1!==d&&e.state.selection.splice(d,1),a},e.state.selection);else if(a.isArray(b))e.state.selection=b.reduce(function(b,c){var d=a.isObject(c)?c[e.cfg.selectionKey]:c,f=e.state.selection.indexOf(d);return-1!==f&&e.state.selection.splice(f,1),b},e.state.selection);else{var c=a.isObject(b)?b[e.cfg.selectionKey]:b,d=e.state.selection.indexOf(c);-1!==d&&e.state.selection.splice(d,1)}},this.getSelection=function(){return e.state.selection},this.setSelection=function(b){for(var c=[],d=0;d<b.length;d++){var f=b[d],g=a.isObject(f)?f[e.cfg.selectionKey]:f;-1===c.indexOf(g)&&c.push(g)}e.state.selection=c}}],link:{pre:function(a,b,c,d){null!==d[1]&&(d[1].init(d[0],b),a.$ctrl=d[1])},post:function(b,c,d,f){var g=d.uxTable,h=a.isDefined(g)?b.$parent.$eval(g):{};f.cfg=a.extend(e,h),b.cfg=f.cfg,f[0].setColumns(b.cfg.columns),f[0].setSource(b.cfg.source),f[0].reload(),b.setSorting=function(a){f[0].setSorting(a)};var i=b.cfg.name;b.$parent[i]=f[0]}}}}]).directive("uxTableCell",["$compile",function(b){return{priority:0,scope:!1,require:"^uxTable",link:function(c,d,e,f){var g=c.column.template;a.isString(g)&&d.html(b(g)(c))}}}]).directive("uxTableSelection",["$timeout",function(a){return{priority:0,replace:!0,require:"^uxTable",scope:{content:"=",selection:"=",selectionKey:"="},link:function(b,c,d,e){var f=function(a,d){if(a!==d){for(var e=0,f=0;f<b.content.length;f++)-1!==b.selection.indexOf(b.content[f][b.selectionKey])&&(e+=1);switch(e){case 0:c.prop("checked",!1).prop("indeterminate",!1);break;case b.content.length:c.prop("checked",!0).prop("indeterminate",!1);break;default:c.prop("checked",!1).prop("indeterminate",!0)}}};b.$watch("content",f,!0),b.$watch("selection",f,!0),c.bind("change",function(){a(function(){c.prop("checked")?e.select(b.content):e.deselect(b.content)})})}}}]).directive("uxTablePagination",function(){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTablePagination.html",link:function(b,c,d,e){var f=d.uxTablePagination,g=a.isDefined(f)?b.$parent.$eval(f):{};b.cfg=a.extend({maxSize:5,rotate:!0,directionLinks:!0,previousText:"‹",nextText:"›",boundaryLinks:!0,firstText:"«",lastText:"»"},g,{isInit:!1,ngModel:0,totalItems:0,itemsPerPage:0,ngChange:function(){e.$isInit&&e.$tableCtrl.setPagination(b.cfg.ngModel-1,null)}}),b.$on("uxTable.paginationChanged",function(a,c){b.cfg.ngModel=c.page+1,b.cfg.totalItems=c.countTotal,b.cfg.itemsPerPage=c.pageSize,b.cfg.isInit=!0})}}}).directive("uxTablePaginationSize",function(){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTablePaginationSize.html",link:{pre:function(b,c,d,e){var f=d.uxTablePaginationSize,g=a.isDefined(f)?b.$parent.$eval(f):{};b.cfg=a.extend({closeOnBlur:!0,buttonClasses:"btn btn-default"},g,{dynamicTitle:!0,displayProp:"label",idProp:"id",externalIdProp:"id",enableSearch:!1,selectionLimit:1,showCheckAll:!1,showUncheckAll:!1,closeOnSelect:!0,closeOnDeselect:!0,groupByTextProvider:a.noop,scrollable:!0,scrollableHeight:"auto",smartButtonMaxItems:1,smartButtonTextConverter:a.noop,options:[{id:10,label:"10"},{id:25,label:"25"},{id:50,label:"50"},{id:100,label:"100"}],events:{onItemSelect:function(a){e.$isInit&&e.$tableCtrl.setPagination(0,a.id)}},isInit:!1}),b.ngModel={id:0},b.$on("uxTable.paginationChanged",function(a,c){if(!_.some(b.cfg.options,"id",c.pageSize)){var d=_.findIndex(b.cfg.options,function(a){return a.id>c.pageSize});d=0>d?b.cfg.options.length:d,b.cfg.options.splice(d,0,{id:c.pageSize,label:""+c.pageSize})}b.ngModel={id:c.pageSize},b.cfg.isInit=!0})}}}}).directive("uxTableSelectionCounter",["$compile",function(b){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTableSelectionCounter.html",link:function(c,d,e,f){var g=e.uxTableSelectionCounter,h=a.isDefined(g)?c.$parent.$eval(g):{};c.cfg=a.extend({i18n:!1,template:'<span ng-show="selectionSize">{{ selectionSize }} selected (<a href="#" ng-click="resetSelection()">clear</a>)</span>'},h),a.isString(c.cfg.i18n)||d.html(b(c.cfg.template)(c)),c.resetSelection=function(){f.$tableCtrl.setSelection([])};var i=function(b,d){var e={selectionKeys:d,selectionSize:d.length};a.isString(c.cfg.i18n)?c.selection=e:a.extend(c,e)};i(null,[]),c.$on("uxTable.selectionChanged",i)}}}]).directive("uxTableCounter",["$compile",function(b){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTableCounter.html",link:function(c,d,e,f){var g=e.uxTableCounter,h=a.isDefined(g)?c.$parent.$eval(g):{};c.cfg=a.extend({i18n:!1,template:"<span>{{ page * pageSize + 1 }} &ndash; {{ page * pageSize + count }} of {{ countTotal }}</span>"},h,{isInit:!1}),a.isString(c.cfg.i18n)||d.html(b(c.cfg.template)(c)),c.$on("uxTable.paginationChanged",function(b,d){a.isString(c.cfg.i18n)?c.pagination=d:a.extend(c,d),c.isInit=!0})}}}]).directive("uxTableToggle",["$q","$timeout","$translate",function(b,c,d){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTableToggle.html",link:{pre:function(c,e,f,g){var h=f.uxTableToggle,i=a.isDefined(h)?c.$parent.$eval(h):{};c.cfg=a.extend({closeOnBlur:!0,buttonClasses:"btn btn-default",icon:"zmdi zmdi-view-column",caret:!0},i,{dynamicTitle:!1,displayProp:"name",idProp:"key",externalIdProp:"key",enableSearch:!1,selectionLimit:0,showCheckAll:!1,showUncheckAll:!1,closeOnSelect:!1,closeOnDeselect:!1,groupByTextProvider:a.noop,scrollable:!0,scrollableHeight:"auto",smartButtonMaxItems:0,smartButtonTextConverter:a.noop,options:[],events:{onItemSelect:function(a){g.$isInit&&g.$tableCtrl.toggleVisibility(a.key,!0)},onItemDeselect:function(a){0===c.ngModel.length?c.ngModel.push(a):g.$isInit&&g.$tableCtrl.toggleVisibility(a.key,!1)}},isInit:!1}),c.ngModel=[],c.$on("uxTable.columnsChanged",function(e,f){c.cfg.options=[];var g=b.defer();g.resolve([]);for(var h=g.promise,i=function(c,e){if(a.isString(c.i18n))return d(c.i18n).then(function(a){return c.name=a,delete c.i18n,e.push(c),e});e.push(c);var f=b.defer();return f.resolve(e),f.promise},j=0;j<f.length;j++){var k=_.pick(f[j],"key","name","i18n");h=h.then(_.bind(i,this,k))}h.then(function(a){c.cfg.options=a});for(var l=[],m=0;m<f.length;m++)f[m].show&&l.push({key:f[m].key});c.ngModel=l,c.cfg.isInit=!0})},post:function(a,b,c,d){var e='<i class="'+a.cfg.icon+'"></i>';a.cfg.caret&&(e+='&nbsp;<span class="caret"></span>'),b.find("button").html(e)}}}}])}(angular),angular.module("mindsmash.uxTable").run(["$templateCache",function(a){"use strict";a.put("_uxTable.html",'<table class="ux-table" ng-class="cfg.tableClass"><thead><tr><th class="ux-table-selection"><input type="checkbox" ux-table-selection content="content" selection="state.selection" selection-key="cfg.selectionKey"></th><th ng-repeat="column in columns | filter : { show: true }" ng-click="setSorting(column.key)" ng-class="{ \'sort\': column.sort !== false, \'sort-asc\': state.orderBy.key === column.key && state.orderBy.asc === true, \'sort-desc\': state.orderBy.key=== column.key && state.orderBy.asc === false }"><span ng-if="column.i18n">{{ column.i18n | translate }}</span> <span ng-if="!column.i18n">{{ column.name }}</span></th></tr></thead><tbody><tr ng-repeat="row in content" ng-init="$rowIndex = state.page * state.pageSize + $index + 1; $rowClass = cfg.rowClick(row, idx);" ng-click="cfg.rowClick(row, $rowIndex, $event)" ng-class="$rowClass"><td class="ux-table-selection"><input type="checkbox" checklist-model="state.selection" checklist-value="row[cfg.selectionKey]"></td><td ng-repeat="column in columns | filter : { show: true }" ux-table-cell data-label="{{ column.i18n ? (column.i18n | translate) : column.name }}" data-empty="{{ !row[column.key] }}">{{ row[column.key] }}</td></tr></tbody></table>'),a.put("_uxTableCounter.html",'<div class="ux-table-counter" ng-show="isInit">{{ cfg.i18n | translate : pagination }}</div>'),a.put("_uxTablePagination.html",'<div class="ux-table-pagination" ng-show="cfg.isInit"><pagination ng-change="cfg.ngChange()" ng-model="cfg.ngModel" total-items="cfg.totalItems" items-per-page="cfg.itemsPerPage" max-size="cfg.maxSize" rotate="cfg.rotate" direction-links="cfg.directionLinks" previous-text="{{ cfg.previousText }}" next-text="{{ cfg.nextText }}" boundary-links="cfg.boundaryLinks" first-text="{{ cfg.firstText }}" last-text="{{ cfg.lastText }}"></pagination></div>'),a.put("_uxTablePaginationSize.html",'<div class="ux-table-pagination-size" ng-show="cfg.isInit"><ng-dropdown-multiselect selected-model="ngModel" options="cfg.options" extra-settings="cfg" events="cfg.events"></ng-dropdown-multiselect></div>'),a.put("_uxTableSelectionCounter.html",'<div class="ux-table-selection-counter"><span ng-show="\\&quot;selection.selectionSize\\&quot;">{{ (cfg.i18n + \'.count\') | translate : selection }} (<a href="#" ng-click="resetSelection()">{{ (cfg.i18n + \'.clear\') | translate : selection }}</a>)</span></div>'),a.put("_uxTableToggle.html",'<div class="ux-table-toggle" ng-show="cfg.isInit"><ng-dropdown-multiselect selected-model="ngModel" options="cfg.options" extra-settings="cfg" checkboxes="true" events="cfg.events" ng-class="cfg.css"></ng-dropdown-multiselect></div>')}]);