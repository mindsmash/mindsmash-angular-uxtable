/*! 
 * mindsmash-angular-uxtable v0.0.1
 * https://github.com/mindsmash/mindsmash-angular-uxtable
 * Copyright (c) 2015 mindsmash GmbH
 * License: MIT
 */
!function(a){"use strict";a.module("mindsmash.uxTable",["angularjs-dropdown-multiselect","ui.bootstrap.pagination"]).directive("uxTableScope",function(){return{priority:100,restrict:"A",controller:["$scope",function(a){this.$isInit=!1,this.$tableCtrl=void 0,this.$tableElem=void 0,this.init=function(a,b){a&&b&&(this.$isInit=!0,this.$tableCtrl=a,this.$tableElem=b)},this.broadcast=function(b,c){a.$broadcast(b,c)}}]}}).constant("uxTableConf",{tableClass:"table table-striped",requestConverter:function(b){var c=b.orderBy;return _.pick({_page:b.page,_pageSize:b.pageSize,_orderBy:c&&c.key?c.key+(c.asc?",asc":",desc"):null},function(b){return a.isDefined(b)&&null!==b})},responseConverter:function(b){var c={state:{count:b.page.numberOfElements,countTotal:b.page.totalElements,page:b.page.number,pageSize:b.page.size},content:b};return a.isArray(b.sort)&&b.sort.length>0&&(c.state.orderBy={key:b.sort[0].property,asc:b.sort[0].ascending}),c}}).directive("uxTable",["$http","$q","$timeout","Util","uxTableConf",function(b,c,d,e,f){return{scope:!0,priority:10,restrict:"A",require:["uxTable","?^^uxTableScope"],templateUrl:"_uxTable.html",controller:["$scope","$element",function(e,f){var g=function(a,b){e.$ctrl&&e.$ctrl.$isInit?e.$ctrl.broadcast(a,b):e.$broadcast(a,b)};e.source=null,this.setSource=function(a){return e.source=a,g("uxTable.source",e.columns),this},e.columns=[],this.newColumn=function(b){return a.extend({show:!0,sort:!0},b)},this.setColumns=function(b){return a.isArray(b)&&b.length>0&&(e.columns=_.map(b,function(a){return this.newColumn(a)},this),_.some(e.columns,"show",!0)||(e.columns[0].show=!0)),g("uxTable.columns",e.columns),this},this.addColumn=function(b,c){return c=a.isDefined(c)?c:e.columns.length,e.columns.splice(c,0,this.newColumn(b)),g("uxTable.columns",e.columns),this},this.removeColumn=function(a){if(e.columns.length>1){var b=_.findIndex(e.columns,"key",a);e.columns.splice(b,1),_.some(e.columns,"show",!0)||(e.columns[0].show=!0)}return g("uxTable.columns",e.columns),this},this.toggleColumn=function(b,c){var d=_.find(e.columns,"key",b);d&&(c=a.isDefined(c)?c:!d.show,(c||_.some(e.columns,function(a){return a.key!==b&&a.show===!0}))&&(d.show=c,g("uxTable.columns",e.columns)))},e.state={page:0,pageSize:10,orderBy:{key:"id",asc:!0}},this.sortColumn=function(a,b){var c=_.find(e.columns,"key",a);c&&c.sort&&(e.state.orderBy&&e.state.orderBy.key===a?e.state.orderBy.asc===!0?e.state.orderBy.asc=!1:e.state.orderBy.asc===!1&&delete e.state.orderBy:e.state.orderBy={key:a,asc:b!==!1},g("uxTable.state",e.state),this.reload())},this.setPage=function(b,c){var d=!1;a.isNumber(b)&&b>=0&&(e.state.page=b,d=!0),a.isNumber(c)&&c>0&&(e.state.pageSize=c,d=!0),d&&(g("uxTable.state",e.state),this.reload())},e.content=[],this.reload=function(){var f=null;if(a.isFunction(e.source)){var h=e.cfg.requestConverter(e.state);f=e.source(h)}else if(a.isObject(e.source))f=b(e.source);else if(a.isArray(e.source)){var i=e.state.page*e.state.size,j=e.source.slice(i,i+e.state.size),k=c.defer();k.resolve(j),f=k.promise}null!==f&&f.then(function(b){e.cfg.fetch(b),d(function(){var c=e.cfg.responseConverter(b);a.extend(e.state,c.state),g("uxTable.state",e.state),e.content=c.content,g("uxTable.content",e.content)})})}}],link:{pre:function(a,b,c,d){null!==d[1]&&(d[1].init(d[0],b),a.$ctrl=d[1])},post:function(b,c,d,g){var h=d.uxTable,i=a.isDefined(h)?b.$parent.$eval(h):{};b.cfg=a.extend(f,i),g[0].setColumns(b.cfg.columns),g[0].setSource(b.cfg.source),g[0].reload(),b.sortColumn=function(a){g[0].sortColumn(a)};var j=b.cfg.name||e.uuid();b.$parent[j]=g[0]}}}}]).directive("uxTableCell",["$compile",function(b){return{priority:0,scope:!1,require:"^uxTable",link:function(c,d,e,f){var g=c.column.template;a.isString(g)&&d.html(b(g)(c))}}}]).directive("uxTablePagination",function(){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTablePagination.html",link:function(b,c,d,e){var f=d.uxTablePagination,g=a.isDefined(f)?b.$parent.$eval(f):{};b.cfg=a.extend({maxSize:5,rotate:!0,directionLinks:!0,previousText:"‹",nextText:"›",boundaryLinks:!0,firstText:"«",lastText:"»"},g,{isInit:!1,ngModel:0,totalItems:0,itemsPerPage:0,ngChange:function(){e.$isInit&&e.$tableCtrl.setPage(b.cfg.ngModel-1,null)}}),b.$on("uxTable.state",function(a,c){b.cfg.ngModel=c.page+1,b.cfg.totalItems=c.countTotal,b.cfg.itemsPerPage=c.pageSize,b.cfg.isInit=!0})}}}).directive("uxTablePaginationSize",function(){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTablePaginationSize.html",link:{pre:function(b,c,d,e){var f=d.uxTablePaginationSize,g=a.isDefined(f)?b.$parent.$eval(f):{};b.cfg=a.extend({closeOnBlur:!0,buttonClasses:"btn btn-default"},g,{dynamicTitle:!0,displayProp:"label",idProp:"id",externalIdProp:"id",enableSearch:!1,selectionLimit:1,showCheckAll:!1,showUncheckAll:!1,closeOnSelect:!0,closeOnDeselect:!0,groupByTextProvider:a.noop,scrollable:!0,scrollableHeight:"auto",smartButtonMaxItems:1,smartButtonTextConverter:a.noop,options:[{id:10,label:"10"},{id:25,label:"25"},{id:50,label:"50"},{id:100,label:"100"}],events:{onItemSelect:function(a){e.$isInit&&e.$tableCtrl.setPage(0,a.id)}},isInit:!1}),b.ngModel={id:0},b.$on("uxTable.state",function(a,c){if(!_.some(b.cfg.options,"id",c.pageSize)){var d=_.findIndex(b.cfg.options,function(a){return a.id>c.pageSize});d=0>d?b.cfg.options.length:d,b.cfg.options.splice(d,0,{id:c.pageSize,label:""+c.pageSize})}b.ngModel={id:c.pageSize},b.cfg.isInit=!0})}}}}).directive("uxTableCounter",["$compile",function(b){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTableCounter.html",link:function(c,d,e,f){var g=e.uxTableCounter,h=a.isDefined(g)?c.$parent.$eval(g):{};c.cfg=a.extend({i18n:!1,template:"<span>{{ page * pageSize + 1 }} &ndash; {{ page * pageSize + count }} of {{ countTotal }}</span>"},h,{isInit:!1}),a.isString(c.cfg.i18n)||d.html(b(c.cfg.template)(c)),c.$on("uxTable.state",function(b,d){a.isString(c.cfg.i18n)?c.state=d:a.extend(c,d),c.isInit=!0})}}}]).directive("uxTableToggle",["$q","$timeout","$translate",function(b,c,d){return{priority:0,scope:!0,replace:!0,restrict:"A",require:"^uxTableScope",templateUrl:"_uxTableToggle.html",link:{pre:function(c,e,f,g){var h=f.uxTableToggle,i=a.isDefined(h)?c.$parent.$eval(h):{};c.cfg=a.extend({closeOnBlur:!0,buttonClasses:"btn btn-default",icon:"zmdi zmdi-view-column",caret:!0},i,{dynamicTitle:!1,displayProp:"name",idProp:"key",externalIdProp:"key",enableSearch:!1,selectionLimit:0,showCheckAll:!1,showUncheckAll:!1,closeOnSelect:!1,closeOnDeselect:!1,groupByTextProvider:a.noop,scrollable:!0,scrollableHeight:"auto",smartButtonMaxItems:0,smartButtonTextConverter:a.noop,options:[],events:{onItemSelect:function(a){g.$isInit&&g.$tableCtrl.toggleColumn(a.key,!0)},onItemDeselect:function(a){0===c.ngModel.length?c.ngModel.push(a):g.$isInit&&g.$tableCtrl.toggleColumn(a.key,!1)}},isInit:!1}),c.ngModel=[],c.$on("uxTable.columns",function(e,f){c.cfg.options=[];var g=b.defer();g.resolve([]);for(var h=g.promise,i=function(c,e){if(a.isString(c.i18n))return d(c.i18n).then(function(a){return c.name=a,delete c.i18n,e.push(c),e});e.push(c);var f=b.defer();return f.resolve(e),f.promise},j=0;j<f.length;j++){var k=_.pick(f[j],"key","name","i18n");h=h.then(_.bind(i,this,k))}h.then(function(a){c.cfg.options=a});for(var l=[],m=0;m<f.length;m++)f[m].show&&l.push({key:f[m].key});c.ngModel=l,c.cfg.isInit=!0})},post:function(a,b,c,d){var e='<i class="'+a.cfg.icon+'"></i>';a.cfg.caret&&(e+='&nbsp;<span class="caret"></span>'),b.find("button").html(e)}}}}])}(angular),angular.module("mindsmash.uxTable").run(["$templateCache",function(a){"use strict";a.put("_uxTable.html",'<table class="ux-table" ng-class="cfg.tableClass"><thead><tr><th ng-repeat="column in columns | filter : { show: true }" ng-click="sortColumn(column.key)" ng-class="{ \'sort\': column.sort !== false, \'sort-asc\': state.orderBy.key === column.key && state.orderBy.asc === true, \'sort-desc\': state.orderBy.key=== column.key && state.orderBy.asc === false }"><span ng-if="column.i18n">{{ column.i18n | translate }}</span> <span ng-if="!column.i18n">{{ column.name }}</span></th></tr></thead><tbody><tr ng-repeat="row in content"><td ng-repeat="column in columns | filter : { show: true }" ux-table-cell>{{ row[column.key] }}</td></tr></tbody></table>'),a.put("_uxTableCounter.html",'<div class="ux-table-counter" ng-show="isInit">{{ cfg.i18n | translate : state }}</div>'),a.put("_uxTablePagination.html",'<div class="ux-table-pagination" ng-show="cfg.isInit"><pagination ng-change="cfg.ngChange()" ng-model="cfg.ngModel" total-items="cfg.totalItems" items-per-page="cfg.itemsPerPage" max-size="cfg.maxSize" rotate="cfg.rotate" direction-links="cfg.directionLinks" previous-text="{{ cfg.previousText }}" next-text="{{ cfg.nextText }}" boundary-links="cfg.boundaryLinks" first-text="{{ cfg.firstText }}" last-text="{{ cfg.lastText }}"></pagination></div>'),a.put("_uxTablePaginationSize.html",'<div class="ux-table-pagination-size" ng-show="cfg.isInit"><ng-dropdown-multiselect selected-model="ngModel" options="cfg.options" extra-settings="cfg" events="cfg.events"></ng-dropdown-multiselect></div>'),a.put("_uxTableToggle.html",'<div class="ux-table-toggle" ng-show="cfg.isInit"><ng-dropdown-multiselect selected-model="ngModel" options="cfg.options" extra-settings="cfg" checkboxes="true" events="cfg.events" ng-class="cfg.css"></ng-dropdown-multiselect></div>')}]);